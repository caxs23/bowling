<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°„í˜¸ë¶€ ë³¼ë§ëŒ€íšŒ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <style>
        body { 
            margin: 0; padding: 0; overflow: hidden; background-color: #000; 
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; 
            /* ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ê°„ì„­ ë°©ì§€ */
            touch-action: none; 
        }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; color: white; }
        
        /* ì‹œì‘ í™”ë©´ */
        #start-screen { 
            position: absolute; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            pointer-events: auto; text-align: center; color: #333; z-index: 100;
        }
        .title { font-size: 2.5rem; font-weight: bold; color: #ff4757; margin-bottom: 20px; }
        .instructions { font-size: 1rem; line-height: 1.6; margin-bottom: 30px; color: #444; padding: 0 20px; }
        .btn-group { display: flex; flex-direction: column; gap: 12px; align-items: center; }
        .btn { 
            padding: 12px 30px; font-size: 1.2rem; background: #2ed573; border: none; 
            border-radius: 50px; color: white; cursor: pointer; transition: transform 0.2s; 
            box-shadow: 0 4px 15px rgba(46,213,115,0.4); pointer-events: auto;
            min-width: 250px;
        }
        .btn.secondary { background: #747d8c; box-shadow: 0 4px 15px rgba(116,125,140,0.4); }
        .btn:active { transform: scale(0.95); }

        /* ì˜¤í”„ë‹ ì»¨í…Œì´ë„ˆ */
        #opening-container {
            position: absolute; width: 100%; height: 100%; background: #1a1a1a;
            display: none; pointer-events: auto; z-index: 200;
        }
        .opening-scene {
            position: absolute; width: 100%; height: 100%; opacity: 0;
            transition: opacity 0.8s ease-in-out;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 15vh;
        }
        .opening-scene.active { opacity: 1; }
        .opening-text-box {
            background: rgba(0, 0, 0, 0.85); padding: 20px 30px; border-radius: 12px;
            color: white; font-size: 1.3rem; text-align: center; line-height: 1.5;
            width: 80%; max-width: 500px; border: 1px solid rgba(255,255,255,0.2);
        }
        #opening-next-btn { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 210; }

        /* ê²Œì„ UI */
        #score-board { 
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%); 
            background: rgba(255, 255, 255, 0.9); padding: 10px 25px; border-radius: 12px;
            display: flex; gap: 30px; font-size: 1rem; color: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            min-width: 280px; justify-content: space-around;
        }
        .score-item { display: flex; flex-direction: column; align-items: center; }
        .score-label { font-size: 0.8rem; color: #666; margin-bottom: 2px; }
        .score-val { font-weight: bold; color: #ff4757; font-size: 1.3rem; }

        #message-box { 
            position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 3.5rem; font-weight: 900; color: #ff4757; text-shadow: 2px 2px 5px rgba(255,255,255,0.8);
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }

        .dialogue {
            position: absolute; padding: 5px 12px; background: white; color: black;
            border-radius: 8px; font-size: 0.85rem; font-weight: bold; pointer-events: none;
            transform: translate(-50%, -100%); display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 20; white-space: nowrap; border: 1px solid #ddd;
        }
        canvas { display: block; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="start-screen">
            <div class="title">ğŸ’‰ ê°„í˜¸ë¶€ ë³¼ë§ëŒ€íšŒ</div>
            <div class="instructions">
                í™”ë©´ì„ <strong>ìœ„ë¡œ ë¹ ë¥´ê²Œ ìŠ¤ì™€ì´í”„</strong>í•˜ì—¬ ê³µì„ ë˜ì§€ì„¸ìš”!<br>
                í•€ì„ ì“°ëŸ¬ëœ¨ë ¤ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë‚ ë ¤ë²„ë¦¬ì„¸ìš”.
            </div>
            <div class="btn-group">
                <button class="btn" onclick="startOpening()">ê²½ê¸° ì‹œì‘ (ì˜¤í”„ë‹ ë³´ê¸°)</button>
                <button class="btn secondary" onclick="startGameDirectly()">ë°”ë¡œ ì‹œì‘</button>
            </div>
        </div>

        <div id="opening-container">
            <div id="scene-1" class="opening-scene" style="background-image: url('https://raw.githubusercontent.com/caxs23/3d-model/main/reopening1.png');">
                <div class="opening-text-box">ì˜¤ëŠ˜ë„ ì¦ê±°ìš´ ì¶œê·¼ê¸¸! ì–´ë–¤ ì¼ì„ í•˜ê²Œ ë ê¹Œ?</div>
            </div>
            <div id="scene-2" class="opening-scene" style="background-image: url('https://raw.githubusercontent.com/caxs23/3d-model/main/reopening2.png');">
                <div class="opening-text-box">ì¸ê°„ ë†ˆë“¤.. ê·¸ë™ì•ˆ ìš°ë¦¬ë¥¼ ì‹ ë‚˜ê²Œ ë„˜ì–´ëœ¨ë ¸ê² ë‹¤. ë³µìˆ˜ë‹¤!</div>
            </div>
            <div id="scene-3" class="opening-scene" style="background-image: url('https://raw.githubusercontent.com/caxs23/3d-model/main/reopening3.png');">
                <div class="opening-text-box">ìœ¼ì•„ì•…! ì´ê²Œ ë­ì•¼!</div>
            </div>
            <div id="scene-4" class="opening-scene" style="background-image: url('https://raw.githubusercontent.com/caxs23/3d-model/main/opening4.png');">
                <div class="opening-text-box">ë‚´ê°€.. ë³¼ë§í•€ì´ ë˜ì–´ë²„ë ¸ì–´!!</div>
            </div>
            <button id="opening-next-btn" class="btn" onclick="nextOpeningScene()">ê³„ì†</button>
        </div>

        <div id="score-board" style="display: none;">
            <div class="score-item"><span class="score-label">í”„ë ˆì„</span><span class="score-val" id="frame-num">1</span></div>
            <div class="score-item"><span class="score-label">íˆ¬êµ¬</span><span class="score-val" id="shot-num">1</span></div>
            <div class="score-item"><span class="score-label">ì ìˆ˜</span><span class="score-val" id="total-score">0</span></div>
        </div>

        <div id="message-box">STRIKE!</div>
    </div>

    <script>
        const ASSETS = {
            obj: 'https://raw.githubusercontent.com/caxs23/3d-model/main/base.obj',
            diffuse: 'https://raw.githubusercontent.com/caxs23/3d-model/main/texture_diffuse.png',
            pbr: 'https://raw.githubusercontent.com/caxs23/3d-model/main/texture_pbr.png',
            strikeSound: 'https://raw.githubusercontent.com/caxs23/3d-model/main/Bowling%20Strike%20-%20Sound%20Effect%20for%20editing%20(mp3cut.net).mp3',
            throwSound: 'https://raw.githubusercontent.com/caxs23/3d-model/main/throw.mp3'
        };

        const DIALOGUES = ["ìœ¼ì•…!", "ì‚´ë ¤ì£¼ì„¸ìš”", "í‡´ê·¼í•˜ê³  ì‹¶ì–´", "ì„ ìƒë‹˜!", "ë„ë§ì³!", "íœ´ê°€ ë³´ë‚´ì¤˜!"];

        let scene, camera, renderer, world;
        let ball, ballBody, pins = [], pinBodies = [];
        let isThrowing = false, gameActive = false;
        let frameCount = 1, shotCount = 1, totalScore = 0, pinsStandingCount = 10;
        let swipeStart = { x: 0, y: 0, time: 0 };
        
        const strikeSound = new Audio(ASSETS.strikeSound);
        const throwSound = new Audio(ASSETS.throwSound);

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe0e6ed);
            scene.fog = new THREE.Fog(0xe0e6ed, 20, 60);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            resetCamera();

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            world = new CANNON.World();
            world.gravity.set(0, -9.82, 0);
            world.allowSleep = true; // Sleep ê¸°ëŠ¥ í™œì„±í™”

            createLights();
            createEnvironment();
            createBall();
            loadPinModel();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í„°ì¹˜ ê°„ì„­ í•´ê²° í¬í•¨)
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('touchstart', onTouchStart, { passive: false });
            document.addEventListener('touchend', onTouchEnd, { passive: false });
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mouseup', onMouseUp);
        }

        function createLights() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(5, 15, 5);
            sun.castShadow = true;
            scene.add(sun);
        }

        function createEnvironment() {
            const laneGeo = new THREE.BoxGeometry(6, 0.2, 40);
            const laneMat = new THREE.MeshStandardMaterial({ color: 0xd2a679 });
            const lane = new THREE.Mesh(laneGeo, laneMat);
            lane.position.set(0, -0.1, -15);
            lane.receiveShadow = true;
            scene.add(lane);

            const groundBody = new CANNON.Body({ mass: 0, shape: new CANNON.Box(new CANNON.Vec3(3, 0.1, 20)) });
            groundBody.position.set(0, -0.1, -15);
            world.addBody(groundBody);
        }

        function createBall() {
            const ballRadius = 0.5;
            ball = new THREE.Mesh(
                new THREE.SphereGeometry(ballRadius, 32, 32), 
                new THREE.MeshStandardMaterial({ color: 0xff4757, metalness: 0.5, roughness: 0.2 })
            );
            ball.castShadow = true;
            scene.add(ball);

            ballBody = new CANNON.Body({ mass: 6, shape: new CANNON.Sphere(ballRadius) });
            world.addBody(ballBody);
            resetBall();
        }

        function loadPinModel() {
            const loader = new THREE.OBJLoader();
            const texLoader = new THREE.TextureLoader();
            const diffuse = texLoader.load(ASSETS.diffuse);
            const pinMaterial = new THREE.MeshStandardMaterial({ map: diffuse });

            loader.load(ASSETS.obj, (obj) => {
                obj.traverse((child) => { 
                    if (child.isMesh) { 
                        child.geometry.center(); // ëª¨ë¸ ì¤‘ì‹¬ì  ë³´ì • (íŒŒë¬»í˜ ë°©ì§€ í•µì‹¬)
                        child.material = pinMaterial; 
                        child.castShadow = true; 
                    } 
                });
                setupPins(obj);
            });
        }

        function setupPins(model) {
            const spacing = 1.3;
            const offsetZ = -22;
            const pinHeight = 1.8;

            for (let i = 0; i < 4; i++) {
                for (let j = 0; j <= i; j++) {
                    const pinInstance = model.clone();
                    const x = (j - i * 0.5) * spacing;
                    const z = offsetZ - i * spacing;
                    scene.add(pinInstance);
                    pins.push(pinInstance);

                    const body = new CANNON.Body({ 
                        mass: 0.8, 
                        shape: new CANNON.Box(new CANNON.Vec3(0.3, pinHeight/2, 0.3)),
                        allowSleep: true,
                        sleepSpeedLimit: 0.1,
                        sleepTimeLimit: 1.0
                    });
                    
                    body.addEventListener("collide", () => {
                        if (isThrowing) showDialogue(pinInstance);
                    });
                    
                    world.addBody(body);
                    pinBodies.push(body);

                    const el = document.createElement('div');
                    el.className = 'dialogue';
                    document.body.appendChild(el);
                    
                    pinInstance.userData = { 
                        dialogueEl: el, 
                        isHit: false, 
                        initX: x, 
                        initZ: z, 
                        halfHeight: pinHeight/2,
                        lastTime: 0 
                    };
                }
            }
            positionPins();
        }

        function positionPins() {
            pins.forEach((pin, i) => {
                const body = pinBodies[i];
                if (!pin.userData.isHit) {
                    body.velocity.set(0,0,0);
                    body.angularVelocity.set(0,0,0);
                    // ë°”ë‹¥ì— ë”± ë¶™ê²Œ ì„¤ì •
                    body.position.set(pin.userData.initX, pin.userData.halfHeight, pin.userData.initZ);
                    body.quaternion.set(0,0,0,1);
                    pin.visible = true;
                    body.sleep(); // ì‹œì‘ ì‹œ Sleep ëª¨ë“œ ì ìš©
                } else {
                    pin.visible = false;
                    body.position.set(0, -100, 0);
                }
            });
        }

        // --- ì…ë ¥ ë¡œì§ ---
        function handleStart(x, y) {
            if (!gameActive || isThrowing) return;
            swipeStart = { x, y, time: Date.now() };
        }

        function handleEnd(x, y) {
            if (!gameActive || isThrowing) return;
            const dx = x - swipeStart.x;
            const dy = swipeStart.y - y;
            const dt = Date.now() - swipeStart.time;

            if (dy > 30 && dt < 500) {
                const forceZ = Math.min(dy / dt * 15, 45);
                const forceX = (dx / dt) * 5;
                throwBall(forceX, forceZ);
            }
        }

        function onTouchStart(e) { e.preventDefault(); handleStart(e.touches[0].clientX, e.touches[0].clientY); }
        function onTouchEnd(e) { e.preventDefault(); handleEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY); }
        function onMouseDown(e) { handleStart(e.clientX, e.clientY); }
        function onMouseUp(e) { handleEnd(e.clientX, e.clientY); }

        function throwBall(vx, vz) {
            isThrowing = true;
            throwSound.play().catch(()=>{});
            ballBody.velocity.set(vx, 0, -vz);
            ballBody.angularVelocity.set(-vz, 0, -vx);
            setTimeout(checkResult, 4500);
        }

        function checkResult() {
            let hitCount = 0;
            pins.forEach((pin, idx) => {
                if (!pin.userData.isHit) {
                    const body = pinBodies[idx];
                    const up = new CANNON.Vec3(0, 1, 0);
                    const pinUp = body.quaternion.vmult(new CANNON.Vec3(0, 1, 0));
                    // í•€ì´ ê¸°ìš¸ì–´ì§€ê±°ë‚˜ ë†’ì´ê°€ ë‚®ì•„ì§€ë©´ ì“°ëŸ¬ì§„ ê²ƒìœ¼ë¡œ ê°„ì£¼
                    if (up.dot(pinUp) < 0.75 || body.position.y < pin.userData.halfHeight * 0.5) {
                        hitCount++; pin.userData.isHit = true;
                    }
                }
            });

            totalScore += hitCount;
            pinsStandingCount -= hitCount;
            document.getElementById('total-score').innerText = totalScore;

            if (hitCount > 0) {
                strikeSound.play().catch(()=>{});
                showMessage(pinsStandingCount === 0 ? (shotCount === 1 ? "STRIKE!" : "SPARE!") : `${hitCount} PINS!`);
            } else {
                showMessage("GUTTER...");
            }

            setTimeout(() => {
                if (pinsStandingCount === 0 || shotCount === 2) {
                    if (frameCount < 3) { frameCount++; shotCount = 1; resetFullPins(); } 
                    else { endGame(); return; }
                } else { shotCount = 2; }
                updateUI();
                resetBall();
                isThrowing = false;
            }, 1500);
        }

        function resetFullPins() {
            pins.forEach(p => p.userData.isHit = false);
            pinsStandingCount = 10;
            positionPins();
        }

        function updateUI() {
            document.getElementById('frame-num').innerText = frameCount;
            document.getElementById('shot-num').innerText = shotCount;
        }

        function showMessage(txt) {
            const m = document.getElementById('message-box');
            m.innerText = txt; m.style.opacity = '1';
            setTimeout(() => m.style.opacity = '0', 2000);
        }

        function showDialogue(pin) {
            if (Date.now() - pin.userData.lastTime < 1000) return;
            const el = pin.userData.dialogueEl;
            el.innerText = DIALOGUES[Math.floor(Math.random()*DIALOGUES.length)];
            el.style.display = 'block';
            pin.userData.lastTime = Date.now();
            setTimeout(() => el.style.display = 'none', 1200);
        }

        function resetBall() {
            ballBody.velocity.set(0,0,0); ballBody.angularVelocity.set(0,0,0);
            ballBody.position.set(0, 0.5, 4); ballBody.quaternion.set(0,0,0,1);
            resetCamera(); positionPins();
        }

        function resetCamera() { camera.position.set(0, 4, 12); camera.lookAt(0, 0, -5); }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function startOpening() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('opening-container').style.display = 'block';
            nextOpeningScene();
        }
        
        let curScene = 0;
        function nextOpeningScene() {
            if (curScene > 0) document.getElementById(`scene-${curScene}`).classList.remove('active');
            curScene++;
            if (curScene <= 4) {
                document.getElementById(`scene-${curScene}`).classList.add('active');
            } else {
                startGameDirectly();
            }
        }

        function startGameDirectly() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('opening-container').style.display = 'none';
            document.getElementById('score-board').style.display = 'flex';
            gameActive = true; resetFullPins();
        }

        function endGame() {
            gameActive = false;
            document.getElementById('start-screen').style.display = 'flex';
            document.querySelector('.title').innerText = "ê²°ê³¼: " + totalScore + "ì !";
            frameCount = 1; shotCount = 1; totalScore = 0;
        }

        function animate() {
            requestAnimationFrame(animate);
            if (gameActive) {
                world.step(1/60);
                ball.position.copy(ballBody.position);
                ball.quaternion.copy(ballBody.quaternion);

                if (isThrowing && ball.position.z > -20) {
                    camera.position.z += (ball.position.z + 6 - camera.position.z) * 0.1;
                    camera.lookAt(ball.position.x, 1, ball.position.z - 5);
                }

                pins.forEach((pin, i) => {
                    pin.position.copy(pinBodies[i].position);
                    pin.quaternion.copy(pinBodies[i].quaternion);

                    if (pin.userData.dialogueEl.style.display === 'block') {
                        const v = pin.position.clone();
                        v.y += 1.5; v.project(camera);
                        pin.userData.dialogueEl.style.left = `${(v.x * 0.5 + 0.5) * window.innerWidth}px`;
                        pin.userData.dialogueEl.style.top = `${(v.y * -0.5 + 0.5) * window.innerHeight}px`;
                    }
                });
            }
            renderer.render(scene, camera);
        }

        window.onload = () => { init(); animate(); };
    </script>
</body>
</html>
