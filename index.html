<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê°„í˜¸ë¶€ ë³¼ë§ëŒ€íšŒ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; color: white; }
        
        /* ì‹œì‘ í™”ë©´ */
        #start-screen { 
            position: absolute; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            pointer-events: auto; text-align: center; color: #333; z-index: 100;
        }
        .title { font-size: 3rem; font-weight: bold; color: #ff4757; margin-bottom: 20px; text-shadow: 0 0 10px rgba(255,71,87,0.2); }
        .instructions { font-size: 1.1rem; line-height: 1.6; margin-bottom: 40px; color: #444; }
        .btn-group { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .btn { 
            padding: 15px 40px; font-size: 1.5rem; background: #2ed573; border: none; 
            border-radius: 50px; color: white; cursor: pointer; transition: transform 0.2s, background 0.2s; 
            box-shadow: 0 4px 15px rgba(46,213,115,0.4); pointer-events: auto;
            min-width: 280px;
        }
        .btn.secondary { background: #747d8c; box-shadow: 0 4px 15px rgba(116,125,140,0.4); font-size: 1.2rem; }
        .btn:active { transform: scale(0.95); }

        /* ì˜¤í”„ë‹ ì»¨í…Œì´ë„ˆ */
        #opening-container {
            position: absolute; width: 100%; height: 100%; background: #1a1a1a;
            display: none; pointer-events: auto; z-index: 200;
        }
        .opening-scene {
            position: absolute; width: 100%; height: 100%; opacity: 0;
            transition: opacity 1s ease-in-out;
            background-size: contain; 
            background-repeat: no-repeat;
            background-position: center;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 12vh; box-sizing: border-box;
        }
        .opening-scene.active { opacity: 1; }
        .opening-text-box {
            background: rgba(0, 0, 0, 0.8); padding: 25px 40px; border-radius: 15px;
            color: white; font-size: 1.6rem; text-align: center; line-height: 1.6;
            width: 85%; max-width: 600px; border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        #opening-next-btn {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            z-index: 210; background: #ff4757; display: none;
            min-width: 150px;
        }

        /* ê²Œì„ UI */
        #score-board { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            background: rgba(255, 255, 255, 0.9); padding: 12px 30px; border-radius: 15px; border: 2px solid #ddd;
            display: flex; gap: 40px; font-size: 1.1rem; color: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            min-width: 320px; justify-content: space-around; white-space: nowrap;
        }
        .score-item { display: flex; flex-direction: column; align-items: center; min-width: 80px; }
        .score-label { font-size: 0.9rem; color: #666; margin-bottom: 4px; font-weight: 600; }
        .score-val { font-weight: bold; color: #ff4757; font-size: 1.5rem; line-height: 1; }

        #message-box { 
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 4rem; font-weight: 900; color: #ff4757; text-shadow: 2px 2px 5px rgba(255,255,255,0.8);
            opacity: 0; transition: opacity 0.3s; pointer-events: none; text-align: center;
        }

        .dialogue {
            position: absolute; padding: 5px 10px; background: white; color: black;
            border-radius: 10px; font-size: 0.9rem; font-weight: bold; pointer-events: none;
            transform: translate(-50%, -100%); display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid #ddd; z-index: 20; white-space: nowrap;
        }
        .dialogue:after {
            content: ''; position: absolute; bottom: -5px; left: 50%; margin-left: -5px;
            width: 0; height: 0; border-top: 5px solid white; border-left: 5px solid transparent; border-right: 5px solid transparent;
        }

        canvas { display: block; cursor: crosshair; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="start-screen">
            <div class="title">ğŸ’‰ ê°„í˜¸ë¶€ ë³¼ë§ëŒ€íšŒ</div>
            <div class="instructions">
                í™”ë©´ì„ <strong>ì›í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ë¹ ë¥´ê²Œ ìŠ¤ì™€ì´í”„</strong>í•˜ì—¬ ê³µì„ êµ´ë¦¬ì„¸ìš”!<br>
                ì´ 3í”„ë ˆì„ ë™ì•ˆ ê²½ê¸°ê°€ ì§„í–‰ë©ë‹ˆë‹¤.
            </div>
            <div class="btn-group">
                <button class="btn" onclick="startOpening()">ê²½ê¸° ì‹œì‘ (ì˜¤í”„ë‹ ë³´ê¸°)</button>
                <button class="btn secondary" onclick="startGameDirectly()">ì»·ì‹  ì—†ì´ ë°”ë¡œ ì‹œì‘</button>
            </div>
        </div>

        <div id="opening-container">
            <div id="scene-1" class="opening-scene" style="background-image: url('https://raw.githubusercontent.com/caxs23/3d-model/main/reopening1.png');">
                <div class="opening-text-box">ì˜¤ëŠ˜ë„ ì¦ê±°ìš´ ì¶œê·¼ê¸¸! ì–´ë–¤ ì¼ì„ í•˜ê²Œ ë ê¹Œ?</div>
            </div>
            <div id="scene-2" class="opening-scene" style="background-image: url('https://raw.githubusercontent.com/caxs23/3d-model/main/reopening2.png');">
                <div class="opening-text-box">ì¸ê°„ ë†ˆë“¤.. ê·¸ë™ì•ˆ ìš°ë¦¬ë¥¼ ì‹ ë‚˜ê²Œ ë„˜ì–´ëœ¨ë ¸ê² ë‹¤. ë³µìˆ˜ë‹¤!</div>
            </div>
            <div id="scene-3" class="opening-scene" style="background-image: url('https://raw.githubusercontent.com/caxs23/3d-model/main/reopening3.png');">
                <div class="opening-text-box">ìœ¼ì•„ì•…! ì´ê²Œ ë­ì•¼!</div>
            </div>
            <div id="scene-4" class="opening-scene" style="background-image: url('https://raw.githubusercontent.com/caxs23/3d-model/main/opening4.png');">
                <div class="opening-text-box">ë‚´ê°€.. ë³¼ë§í•€ì´ ë˜ì–´ë²„ë ¸ì–´!!</div>
            </div>
            <button id="opening-next-btn" class="btn" onclick="nextOpeningScene()">ê³„ì†</button>
        </div>

        <div id="score-board" style="display: none;">
            <div class="score-item">
                <span class="score-label">í”„ë ˆì„</span>
                <span class="score-val" id="frame-num">1</span>
            </div>
            <div class="score-item">
                <span class="score-label">íˆ¬êµ¬</span>
                <span class="score-val" id="shot-num">1</span>
            </div>
            <div class="score-item">
                <span class="score-label">í˜„ì¬ ì ìˆ˜</span>
                <span class="score-val" id="total-score">0</span>
            </div>
        </div>

        <div id="message-box">STRIKE!</div>
    </div>

    <script>
        const ASSETS = {
            obj: 'https://raw.githubusercontent.com/caxs23/3d-model/main/base.obj',
            diffuse: 'https://raw.githubusercontent.com/caxs23/3d-model/main/texture_diffuse.png',
            pbr: 'https://raw.githubusercontent.com/caxs23/3d-model/main/texture_pbr.png',
            strikeSound: 'https://raw.githubusercontent.com/caxs23/3d-model/main/Bowling%20Strike%20-%20Sound%20Effect%20for%20editing%20(mp3cut.net).mp3',
            throwSound: 'https://raw.githubusercontent.com/caxs23/3d-model/main/throw.mp3'
        };

        const DIALOGUES = ["ìœ¼ì•…!", "ì‚´ë ¤ì£¼ì„¸ìš”", "ì–µ", "ì•„ì´ê³ ", "í‡´ê·¼í•˜ê³  ì‹¶ì–´", "ì„ ìƒë‹˜!", "êº…", "ë„ë§ì³!", "íœ´ê°€ ë³´ë‚´ì¤˜!", "ì˜¤ë²„íƒ€ì„ ì‹«ì–´!"];

        let scene, camera, renderer, world;
        let ball, ballBody, pins = [], pinBodies = [];
        let isThrowing = false, gameActive = false;
        let frameCount = 1, shotCount = 1, totalScore = 0;
        let pinsStandingCount = 10, strikeSoundPlayed = false;
        let swipeStart = { x: 0, y: 0, time: 0 }, isMouseDown = false;

        const strikeSound = new Audio(ASSETS.strikeSound);
        const throwSound = new Audio(ASSETS.throwSound);

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe0e6ed); 
            scene.fog = new THREE.Fog(0xe0e6ed, 20, 60);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            resetCamera();

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            world = new CANNON.World();
            world.gravity.set(0, -9.82, 0);

            createLights();
            createEnvironment();
            createBall();
            loadPinModel();

            window.addEventListener('resize', onWindowResize);
            document.addEventListener('touchstart', onTouchStart);
            document.addEventListener('touchend', onTouchEnd);
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mouseup', onMouseUp);
        }

        function createLights() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(10, 20, 10);
            sun.castShadow = true;
            scene.add(sun);
        }

        function createEnvironment() {
            // ì‹œê°ì  ë ˆì¸ (ë‚˜ë¬´ íŒ ë¬´ëŠ¬ í¬í•¨)
            const laneGeo = new THREE.BoxGeometry(6, 0.2, 40);
            const laneMat = new THREE.MeshStandardMaterial({ color: 0xd2a679, roughness: 0.3 });
            const lane = new THREE.Mesh(laneGeo, laneMat);
            lane.position.set(0, -0.1, -15); // ìƒë‹¨ í‘œë©´ì´ y=0ì— ì˜¤ë„ë¡ ì„¤ì •
            lane.receiveShadow = true;
            scene.add(lane);

            const lineMat = new THREE.MeshBasicMaterial({ color: 0x555555, transparent: true, opacity: 0.3 });
            for (let x = -2.5; x <= 2.5; x += 0.5) {
                const line = new THREE.Mesh(new THREE.PlaneGeometry(0.02, 40), lineMat);
                line.rotation.x = -Math.PI / 2;
                line.position.set(x, 0.005, -15);
                scene.add(line);
            }

            // ë¬¼ë¦¬ì  ë°”ë‹¥ (ì •í™•íˆ y=0ì— ìœ„ì¹˜)
            const groundBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
            groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
            groundBody.position.set(0, 0, 0);
            world.addBody(groundBody);

            // ê°€ì´ë“œ ì›”
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x444444 });
            const wallL = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 40), wallMat);
            wallL.position.set(-3.25, 0.5, -15);
            scene.add(wallL);
            const wallLBody = new CANNON.Body({ mass: 0, shape: new CANNON.Box(new CANNON.Vec3(0.25, 0.5, 20)) });
            wallLBody.position.set(-3.25, 0.5, -15);
            world.addBody(wallLBody);

            const wallR = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 40), wallMat);
            wallR.position.set(3.25, 0.5, -15);
            scene.add(wallR);
            const wallRBody = new CANNON.Body({ mass: 0, shape: new CANNON.Box(new CANNON.Vec3(0.25, 0.5, 20)) });
            wallRBody.position.set(3.25, 0.5, -15);
            world.addBody(wallRBody);
        }

        function createBall() {
            const ballRadius = 0.5;
            ball = new THREE.Group();

            const sphere = new THREE.Mesh(
                new THREE.SphereGeometry(ballRadius, 32, 32), 
                new THREE.MeshStandardMaterial({ color: 0xff4757, metalness: 0.6, roughness: 0.1 })
            );
            sphere.castShadow = true;
            ball.add(sphere);

            // ì†ê°€ë½ êµ¬ë© (êµ¬ì²´ ì•ˆìœ¼ë¡œ ì‚´ì§ íŒŒë¬»íˆê²Œ ë°°ì¹˜)
            const holeGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.1, 16);
            const holeMat = new THREE.MeshBasicMaterial({ color: 0x111111 });
            const holePositions = [
                { p: [0, 0.46, 0.15], r: [0.4, 0, 0] },
                { p: [0.15, 0.44, 0.05], r: [0.4, 0, 0.3] },
                { p: [-0.15, 0.44, 0.05], r: [0.4, 0, -0.3] }
            ];
            holePositions.forEach(h => {
                const hole = new THREE.Mesh(holeGeo, holeMat);
                hole.position.set(...h.p);
                hole.rotation.set(...h.r);
                ball.add(hole);
            });

            scene.add(ball);
            ballBody = new CANNON.Body({ mass: 6, shape: new CANNON.Sphere(ballRadius) });
            world.addBody(ballBody);
            resetBall();
        }

        function loadPinModel() {
            const loader = new THREE.OBJLoader();
            const texLoader = new THREE.TextureLoader();
            const pinMaterial = new THREE.MeshStandardMaterial({ 
                map: texLoader.load(ASSETS.diffuse), 
                roughnessMap: texLoader.load(ASSETS.pbr), 
                metalness: 0.3 
            });

            loader.load(ASSETS.obj, (obj) => {
                obj.traverse(c => { if (c.isMesh) { c.material = pinMaterial; c.castShadow = true; } });
                setupPins(obj);
            });
        }

        function setupPins(model) {
            const spacing = 1.3, offsetZ = -22, rows = 4;
            const pinHeight = 1.8;
            const pinHalfHeight = pinHeight / 2;

            for (let i = 0; i < rows; i++) {
                for (let j = 0; j <= i; j++) {
                    const pinWrap = new THREE.Group();
                    const pinInstance = model.clone();
                    // ëª¨ë¸ì„ ìœ„ë¡œ ì ˆë°˜ë§Œí¼ ë“¤ì–´ì˜¬ë ¤, ê·¸ë£¹ì˜ ì›ì (0,0,0)ì´ ëª¨ë¸ì˜ ë°”ë‹¥ì´ ë˜ê²Œ í•¨
                    pinInstance.position.y = 0; 
                    pinWrap.add(pinInstance);
                    scene.add(pinWrap);
                    pins.push(pinWrap);

                    const x = (j - i * 0.5) * spacing;
                    const z = offsetZ - i * spacing;

                    // ë¬¼ë¦¬ ë°”ë””ëŠ” ì¤‘ì‹¬ ê¸°ì¤€ì´ë¯€ë¡œ, ìœ„ì¹˜ ì„¤ì • ì‹œ yê°’ì— ì ˆë°˜ì„ ë”í•¨
                    const body = new CANNON.Body({ 
                        mass: 0.8, 
                        shape: new CANNON.Box(new CANNON.Vec3(0.25, pinHalfHeight, 0.25)) 
                    });
                    
                    body.addEventListener("collide", (e) => {
                        if (!isThrowing) return;
                        if (!strikeSoundPlayed && (e.body === ballBody || e.target === ballBody)) {
                            strikeSound.currentTime = 0; strikeSound.play().catch(() => {});
                            strikeSoundPlayed = true;
                        }
                        showDialogue(pinWrap);
                    });
                    world.addBody(body);
                    pinBodies.push(body);

                    const el = document.createElement('div');
                    el.className = 'dialogue';
                    document.body.appendChild(el);
                    
                    pinWrap.userData = { 
                        dialogueEl: el, isHit: false, initX: x, initZ: z, 
                        halfHeight: pinHalfHeight 
                    };
                }
            }
            positionPins();
        }

        function positionPins() {
            pins.forEach((pin, i) => {
                const body = pinBodies[i];
                if (!pin.userData.isHit) {
                    body.velocity.set(0,0,0); body.angularVelocity.set(0,0,0);
                    // ë¬¼ë¦¬ ë°”ë””ì˜ ì¤‘ì‹¬ì€ y = ì ˆë°˜ ë†’ì´ (ë°”ë‹¥ì´ y=0ì— ë‹¿ë„ë¡)
                    body.position.set(pin.userData.initX, pin.userData.halfHeight + 0.01, pin.userData.initZ);
                    body.quaternion.set(0,0,0,1);
                    pin.visible = true;
                } else {
                    pin.visible = false; body.position.set(0, -100, 0);
                }
            });
        }

        function throwBall(speedX, speedZ) {
            isThrowing = true; strikeSoundPlayed = false;
            throwSound.currentTime = 0; throwSound.play().catch(() => {});
            ballBody.velocity.set(speedX, 0, -speedZ);
            ballBody.angularVelocity.set(-speedZ, 0, -speedX);
            setTimeout(checkResult, 4500);
        }

        function checkResult() {
            let hitCount = 0;
            pins.forEach((pin, idx) => {
                if (!pin.userData.isHit) {
                    const body = pinBodies[idx];
                    const up = new CANNON.Vec3(0, 1, 0);
                    const pinUp = body.quaternion.vmult(new CANNON.Vec3(0, 1, 0));
                    // í•€ì´ ëˆ•ê±°ë‚˜(ê¸°ìš¸ê¸°), ê³µì¤‘ì— ëœ¨ê±°ë‚˜, ë°”ë‹¥ ì•„ë˜ë¡œ ë‚´ë ¤ê°”ì„ ë•Œ ì²˜ë¦¬
                    if (up.dot(pinUp) < 0.8 || body.position.y < pin.userData.halfHeight * 0.5) {
                        hitCount++; pin.userData.isHit = true;
                    }
                }
            });

            totalScore += hitCount;
            pinsStandingCount -= hitCount;
            document.getElementById('total-score').innerText = totalScore;

            showMessage(hitCount === 10 && shotCount === 1 ? "STRIKE!" : (pinsStandingCount === 0 ? "SPARE!" : `${hitCount} PINS!`));

            setTimeout(() => {
                if (pinsStandingCount === 0 || shotCount === 2) {
                    if (frameCount < 3) { frameCount++; shotCount = 1; resetFullPins(); } else { endGame(); return; }
                } else { shotCount = 2; }
                updateUI(); resetBall(); isThrowing = false;
            }, 1500);
        }

        function resetBall() {
            ballBody.velocity.set(0,0,0); ballBody.angularVelocity.set(0,0,0);
            ballBody.position.set(0, 0.5, 4); ballBody.quaternion.set(0,0,0,1);
            resetCamera(); positionPins();
        }

        function resetFullPins() {
            pins.forEach(p => p.userData.isHit = false);
            pinsStandingCount = 10; positionPins();
        }

        function updateUI() {
            document.getElementById('frame-num').innerText = frameCount;
            document.getElementById('shot-num').innerText = shotCount;
        }

        function showMessage(txt) {
            const msg = document.getElementById('message-box');
            msg.innerText = txt; msg.style.opacity = '1';
            setTimeout(() => msg.style.opacity = '0', 1500);
        }

        function showDialogue(pin) {
            const el = pin.userData.dialogueEl;
            if (el.style.display === 'block') return;
            el.innerText = DIALOGUES[Math.floor(Math.random() * DIALOGUES.length)];
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 1000);
        }

        function resetCamera() { camera.position.set(0, 4, 12); camera.lookAt(0, 0, -5); }
        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        function onTouchStart(e) { startAction(e.touches[0].clientX, e.touches[0].clientY); }
        function onTouchEnd(e) { endAction(e.changedTouches[0].clientX, e.changedTouches[0].clientY); }
        function onMouseDown(e) { isMouseDown = true; startAction(e.clientX, e.clientY); }
        function onMouseUp(e) { if(isMouseDown) { isMouseDown = false; endAction(e.clientX, e.clientY); } }
        function startAction(x, y) { if (!gameActive || isThrowing) return; swipeStart = { x, y, time: Date.now() }; }
        function endAction(x, y) {
            if (!gameActive || isThrowing) return;
            const dy = swipeStart.y - y, dt = Date.now() - swipeStart.time;
            if (dy > 50 && dt < 400) throwBall((x - swipeStart.x) / dt * 5, Math.min(dy / dt * 12, 40));
        }

        function startOpening() { document.getElementById('start-screen').style.display = 'none'; document.getElementById('opening-container').style.display = 'block'; currentOpeningScene = 0; nextOpeningScene(); }
        let currentOpeningScene = 0;
        function nextOpeningScene() {
            currentOpeningScene++;
            if (currentOpeningScene <= 4) {
                if (currentOpeningScene > 1) document.getElementById(`scene-${currentOpeningScene - 1}`).classList.remove('active');
                document.getElementById(`scene-${currentOpeningScene}`).classList.add('active');
                const btn = document.getElementById('opening-next-btn');
                btn.style.display = 'block'; btn.innerText = currentOpeningScene === 4 ? "ì‹œì‘í•˜ê¸°" : "ê³„ì†";
            } else { finishOpening(); }
        }
        function finishOpening() { document.getElementById('opening-container').style.display = 'none'; document.getElementById('score-board').style.display = 'flex'; gameActive = true; resetFullPins(); }
        function startGameDirectly() { document.getElementById('start-screen').style.display = 'none'; document.getElementById('score-board').style.display = 'flex'; gameActive = true; resetFullPins(); }
        function endGame() { gameActive = false; document.getElementById('start-screen').style.display = 'flex'; document.querySelector('.title').innerText = "ê²°ê³¼: " + totalScore + "ì "; frameCount = 1; shotCount = 1; totalScore = 0; updateUI(); }

        function animate() {
            requestAnimationFrame(animate);
            if (gameActive) {
                world.step(1/60);
                ball.position.copy(ballBody.position);
                ball.quaternion.copy(ballBody.quaternion);

                if (isThrowing) {
                    if (ball.position.z > -15) {
                        camera.position.z += (ball.position.z + 6 - camera.position.z) * 0.1;
                        camera.lookAt(ball.position.x * 0.5, 1, ball.position.z - 5);
                    }
                }

                pins.forEach((pin, i) => {
                    const body = pinBodies[i];
                    // ë¬¼ë¦¬ ë°”ë””ì˜ ì¤‘ì‹¬ì—ì„œ ë†’ì´ì˜ ì ˆë°˜ì„ ëº€ ìœ„ì¹˜ì— ì‹œê°ì  ëª¨ë¸(ë°”ë‹¥ ê¸°ì¤€) ë°°ì¹˜
                    pin.position.set(body.position.x, body.position.y - pin.userData.halfHeight, body.position.z);
                    pin.quaternion.copy(body.quaternion);

                    if (pin.userData.dialogueEl.style.display === 'block') {
                        const v = pin.position.clone(); v.y += 2; v.project(camera);
                        pin.userData.dialogueEl.style.left = `${(v.x * 0.5 + 0.5) * window.innerWidth}px`;
                        pin.userData.dialogueEl.style.top = `${(v.y * -0.5 + 0.5) * window.innerHeight}px`;
                    }
                });
            }
            renderer.render(scene, camera);
        }

        window.onload = () => { init(); animate(); };
    </script>
</body>
</html>
